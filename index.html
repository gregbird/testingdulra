<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dulra - Ecological Management Platform</title>
    
    <style>
        [cite_start]/* CSS from original file [cite: 1-14] */
        .view { display: none; }
        .active-view { display: block; }
        body { background-color: #F3F7F9; font-family: 'Inter', sans-serif; margin: 0; }
        main { padding: 1rem; }
        nav { padding: 1rem; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        nav h3 { margin-top: 0; }
        nav ul { list-style: none; padding: 0; }
        nav li { padding: 0.5rem; cursor: pointer; border-radius: 4px; }
        nav li:hover { background: #f3f7f9; }
        header { padding: 1rem; background: #122529; color: #fff; }
        header h1 { margin: 0; }
        button { background-color: #FB923C; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        button:hover { opacity: 0.9; }
        input, textarea, select { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; box-sizing: border-box; }
        label { display: block; margin-top: 0.5rem; font-weight: 500; }
        
        .eiar-textarea { 
            width: 100%; 
            padding: 0.75rem; 
            border-radius: 0.375rem; 
            border: 1px solid #d1d5db; 
            transition: all 0.2s ease-in-out; 
            font-size: 1rem; 
            line-height: 1.5; 
            resize: vertical; 
        }
        .eiar-textarea:focus { 
            outline: 2px solid #FB923C; 
            border-color: #FB923C; 
            box-shadow: 0 0 0 1px #FB923C; 
        }
        .toast { 
            position: fixed; 
            bottom: 2rem; 
            right: 2rem; 
            padding: 1rem 1.5rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
            transform: translateX(calc(100% + 2rem)); 
            transition: transform 0.3s ease-in-out; 
            z-index: 100; 
        }
        .toast.show { transform: translateX(0); }
        .loading-spinner { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #122529; 
            border-radius: 50%; 
            width: 32px; 
            height: 32px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .status-badge { 
            display: inline-block; 
            padding: 0.25rem 0.6rem; 
            border-radius: 0.25rem; 
            font-size: 0.75rem; 
            font-weight: 500; 
            white-space: nowrap; 
        }
        /* Style for Assessment Detail Tables */
        #assessment-detail-view table, .projects-table, #team-view table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 1rem; 
            font-size: 0.875rem; 
        }
        #assessment-detail-view th, #assessment-detail-view td,
        .projects-table th, .projects-table td,
        #team-view th, #team-view td { 
            border: 1px solid #e5e7eb; 
            padding: 0.5rem 0.75rem; 
            text-align: left; 
        }
        #assessment-detail-view th, .projects-table th, #team-view th { 
            background-color: #f9fafb; 
            font-weight: 600; 
        }
        #assessment-detail-view tbody tr:nth-child(even) { 
            background-color: #f9fafb; 
        }
        [contenteditable="true"]:focus { 
            outline: 2px solid #FB923C; 
            box-shadow: 0 0 0 2px #FB923C30; 
        }
        .progress-bar {
            width: 100px;
            height: 10px;
            background-color: #e2e8f0;
            border-radius: 5px;
            display: inline-block;
            overflow: hidden;
            border: 1px solid #cbd5e1;
        }
        .progress-fill {
            height: 100%;
            background-color: #FB923C; /* Accent color */
            border-radius: 5px;
        }
        
        /* Modal Styles */
        .hidden { display: none; }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99;
        }
        .modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            min-width: 300px;
            max-width: 500px;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://unpkg.com/docx@7.3.0/build/docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

</head>
<body>

    <header>
        <h1>Dulra</h1>
        <p>Create a project</p>
    </header>

    <nav>
        <section>
            <h3>Workspace</h3>
            <ul>
                <li onclick="showView('dashboard-view')">Dashboard</li>
                <li onclick="showView('projects-page-view')">Projects</li>
                <li onclick="showView('tasks-view')">Tasks</li>
                <li onclick="showView('my-surveys-view')">Surveys</li>
                <li onclick="showView('team-view')">Team Members</li>
                <li onclick="showView('settings-view')">Settings</li>
            </ul>
        </section>

        <section>
            <h3>Tools for Surveys</h3>
            <ul>
                <li onclick="showView('desktop-research-view')">Desktop Research</li>
                <li onclick="showView('survey-template-view')">Field Survey</li>
                <li onclick="showView('impact-view')">Impact Calculation</li>
                <li onclick="showView('reporting-view')">Intelligent Reporting</li>
                <li onclick="showView('visualisation-view')">Visualisation</li>
            </ul>
        </section>
    </nav>

    <main>
        <section id="dashboard-view" class="view">
            <h2>Dashboard</h2>
            <button onclick="showView('survey-template-view')">Create Task</button>

            <h3>Action Status</h3>
            <div style="height: 250px;"><canvas id="actions-chart"></canvas></div>

            <h3>Assessment Status</h3>
            <div style="height: 250px;"><canvas id="surveys-chart"></canvas></div>

            <h3>Key Stats</h3>
            <p>Total Assessments: <span id="total-assessments-stat">0</span></p>
            <p>Habitats Favourable: <span id="habitats-favourable-stat">0</span></p>
            <p>Habitats Unfavourable: <span id="habitats-unfavourable-stat">0</span></p>
            <p>Species Favourable: <span id="species-favourable-stat">0</span></p>

            <h3>Conservation Site Status</h3>
            <div id="site-status-tabs"></div>
            <div id="site-status-content"></div>
        </section>

        <section id="projects-page-view" class="view">
            <h2>Projects</h2>
            
            <h3>Project Progress Key</h3>
            <ul>
                <li><strong>0% - 25%:</strong> Desktop research</li>
                <li><strong>25% - 50%:</strong> Field survey</li>
                <li><strong>50% - 75%:</strong> Report</li>
                <li><strong>75% - 100%:</strong> Final data deliveries</li>
            </ul>

            <h3>Project List</h3>
            <table class="projects-table">
                <thead>
                    <tr>
                        <th>Project Name (Site Name)</th>
                        <th>Project Code</th>
                        <th>Progress</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="projects-table-body">
                </tbody>
            </table>
        </section>

        <section id="tasks-view" class="view">
            <h2>Tasks</h2>
            <p>Detailed Search</p>
            <div id="tasks-tabs"></div>
            <div id="tasks-content"></div>
        </section>

        <section id="survey-template-view" class="view">
            <h2>Start a New Survey</h2>
            <p>Select a compliant template to begin your report.</p>
            <button onclick="showView('template-editor-view')">Edit Custom Template</button>
            <button onclick="showView('my-surveys-view')">Back to Surveys</button>
            <div id="survey-template-grid" class="grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;"></div>
        </section>

        <section id="template-editor-view" class="view">
            <h2>Custom Template Editor</h2>
            <p>Add your own headings and paragraphs to build a custom survey.</p>
            <button onclick="saveCustomTemplate()">Save Template</button>
            <button onclick="addTemplateElement('heading')">Add Heading</button>
            <button onclick="addTemplateElement('paragraph')">Add Paragraph</button>

            <div id="custom-template-editor" style="border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; min-height: 200px; background: #fff;">
                <h3>Custom Heading 1</h3>
                <p contenteditable="true">This is an editable paragraph. You can add your own content here.</p>
            </div>
        </section>

        <section id="my-surveys-view" class="view">
            <h2>Surveys</h2>
            <p>An overview of all your active and completed surveys.</p>
            <button onclick="showView('survey-template-view')">Create New Survey</button>
            <div id="project-list" class="space-y-4 mt-6" style="display: grid; gap: 1rem;"></div>
        </section>
        
        <section id="project-detail-view" class="view">
            <button onclick="showView('my-surveys-view')">Back to Surveys</button>
            
            <h2 id="project-title" style="margin-top: 1rem;">...Loading...</h2>
            <p><strong>Client:</strong> <span id="project-client">...</span></p>
            <p><strong>Code:</strong> <span id="project-code">...</span></p>
            
            <hr>
            
            <div id="project-tabs"></div>
            <div id="project-tab-content" style="margin-top: 1rem;"></div>
        </section>

        <section id="team-view" class="view">
            <h2>Team Management</h2>
            <p>Manage internal team members and assign tasks to third parties.</p>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="team-list">
                    </tbody>
            </table>
        </section>

        <section id="eiar-editor-view" class="view">
            <h2>Ecological Impact Assessment Report (EIAR) Editor</h2>
            <h4 id="eiar-editor-project-name">Project: ...</h4>
            <button onclick="saveEiarSurvey()">Save and Continue</button>

            <h3>Chapter 1: Introduction</h3>
            <textarea class="eiar-textarea" rows="3"></textarea>
            <h3>Chapter 2: Background & Need for the Project</h3>
            <textarea class="eiar-textarea" rows="3"></textarea>
            <h3>Chapter 3: Consideration of Reasonable Alternatives</h3>
            <textarea class="eiar-textarea" rows="3"></textarea>
            <h3>Chapter 4: Description of the Proposed Development</h3>
            <textarea class="eiar-textarea" rows="3"></textarea>
            <h3>Chapter 5: Population & Human Health</h3>
            <textarea class="eiar-textarea" rows="3"></textarea>
            
            <h3>Chapter 6: Biodiversity (Ecology)</h3>
            <h4>6.1 Introduction & Methodology</h4>
            <p>This chapter presents the Ecological Impact Assessment (EcIA). ...</p>
            
            <h4>6.2 Desk Study</h4>
            <p>A comprehensive desk study was undertaken...</p>
            
            <h4>6.3 Field Surveys</h4>
            <p>Field surveys were conducted...</p>
            
            <h4>6.4 Impact Assessment & Mitigation</h4>
            <p>Potential Impacts: ...</p>

            <h3>Chapter 7: Ornithology</h3>
            </section>

        <section id="ecow-editor-view" class="view">
            <h2>Ecological Clerk of Works (ECoW) Report</h2>
            <h4 id="ecow-editor-project-name">Project: ...</h4>
            <button onclick="saveEcowReport()">Save and Continue</button>

            <h3>1. Project Details</h3>
            <textarea class="eiar-textarea" rows="2"></textarea>
            <h3>2. Monitoring Activities</h3>
            <h4>2.1 Pre-Works Check</h4>
            <textarea class="eiar-textarea" rows="3"></textarea>
            <h4>2.2 Site Supervision Log</h4>
            <textarea class="eiar-textarea" rows="3"></textarea>
            <h4>2.3 ECoW Intervention Log</h4>
            <textarea class="eiar-textarea" rows="3"></textarea>
            </section>

        <section id="desktop-research-view" class="view">
            <h2>Desktop Research</h2>

            <hr>
            
            <h3>GIS mapping</h3>
            <h4>Datasets available for the user to add to the GIS mapping tool</h4>
            <hr>

            <h3>Start GIS Project</h3>
            <hr>
            
            <h3>Data Mine</h3>
            <p>Collate and layer data from various external sources for your desk study.</p>
            
            <form>
                <label>Site Name / Reference</label> <input type="text">
                <label>Site Code (e.g., SAC/SPA Code)</label> <input type="text">
                <label>County</label> <input type="text">
                <label>Websites to Search (comma-separated)</label> <input type="text">
                <button type="button" onclick="performDataMineSearch()">Search for Records</button>
            </form>

            <div id="datamine-results-container" class="hidden">
                <div id="datamine-loading">
                    <div class="loading-spinner"></div>
                    <p>Searching...</p>
                </div>
                <div id="datamine-results-content" class="hidden">
                    <h3>Data Mine Results for "Lough Ennell SAC"</h3>
                    </div>
            </div>
        </section>

        <section id="field-survey-view" class="view">
            <h2>Field Survey Editor</h2>
            <p>Create and edit field survey templates and data.</p>
            
            <h3>Survey Details</h3>
            <label>Survey Name</label> <input type="text">
            <label>Date</label> <input type="date">
            <label>Surveyor(s)</label> <input type="text">
            
            <h3>Site Conditions</h3>
            <h3>Habitat Mapping</h3>
            <button onclick="addHabitatEntry()">Add Entry</button>
            <div id="habitat-entries" class="space-y-4 mt-4" style="display: grid; gap: 1rem;"></div>


            <h3>Fauna</h3>
            <button onclick="addFaunaSighting()">Add Sighting</button>
            <div id="fauna-entries" class="space-y-4 mt-4" style="display: grid; gap: 1rem;"></div>

            <h3>Flora</h3>
            <button onclick="addFloraRecord()">Add Record</button>
            <div id="flora-entries" class="space-y-4 mt-4" style="display: grid; gap: 1rem;"></div>

            <h3>Field Notes</h3>
            <textarea></textarea>
        </section>

        <section id="impact-view" class="view">
            <h2>Wind Farm Collision Risk Model</h2>
            <p>Based on the Nature Scot (Band, 2007) standard for calculating avian collision risk.</p>

            <h3>Stage 1 & 2: Bird Passage Rate</h3>
            <p>Estimates the number of birds passing through the rotors annually based on field survey data.</p>
            <label>Target Species</label> 
            <input type="text" value="Hen Harrier">
            
            <label>Flights at Collision Height (from VP surveys)</label> 
            <input type="number" id="crm-flights-height" value="50" oninput="updateImpactCalculation()">
            
            <label>Total Vantage Point Watch Hours</label> 
            <input type="number" id="crm-vp-hours" value="72" oninput="updateImpactCalculation()">
            
            <p>Estimated Annual Passages through Rotors: <strong id="crm-passages-result">...</strong></p>

            <h3>Stage 3: Collision Probability</h3>
            <p>Calculates the probability of a bird being hit during a single passage through a rotor.</p>
            <h4>Bird Parameters</h4>
            <label>Length (m)</label> 
            <input type="number" id="crm-bird-length" value="0.5" oninput="updateImpactCalculation()">
            
            <label>Wingspan (m)</label> 
            <input type="number" id="crm-bird-wingspan" value="1.2" oninput="updateImpactCalculation()">
            
            <label>Flight Speed (m/s)</label> 
            <input type="number" id="crm-bird-speed" value="10" oninput="updateImpactCalculation()">
            
            <h4>Turbine Parameters</h4>
            <label>Rotor Diameter (m)</label> 
            <input type="number" id="crm-rotor-diameter" value="100" oninput="updateImpactCalculation()">
            
            <label>Max Blade Chord (m)</label> 
            <input type="number" id="crm-blade-chord" value="3" oninput="updateImpactCalculation()">
            
            <label>Blade Pitch (°)</label> 
            <input type="number" id="crm-blade-pitch" value="15" oninput="updateImpactCalculation()">
            
            <label>Rotation (s/rev)</label> 
            <input type="number" id="crm-rotation" value="3" oninput="updateImpactCalculation()">
            
            <p>Calculated Collision Probability per Passage (Average): <strong id="crm-probability-result">...</strong></p>

            <h3>Stage 4 & 5: Adjustments</h3>
            <p>Accounts for turbine downtime and the bird's natural avoidance behaviour.</p>
            <label>Turbine Operational Time (%)</label> 
            <input type="number" id="crm-optime" value="85" oninput="updateImpactCalculation()">
            
            <label>Avoidance Rate (%)</label> 
            <input type="number" id="crm-avoidance" value="98" oninput="updateImpactCalculation()">

            <h3>Estimated Annual Collisions</h3>
            <p><strong id="crm-final-result">...</strong></p>
            <p>This is the predicted mortality assuming no mitigation measures are applied.</p>
        </section>


        <section id="reporting-view" class="view">
            <h3>Generated Report</h3>
            <button>Export</button>
            <div id="ai-report-content" style="border: 1px solid #ccc; padding: 1rem; min-height: 200px; background: #fff;">
                <p>Your AI-generated report will appear here. Use the AI assistant on the right to get started.</p>
            </div>
            
            <h3>AI Reporting Assistant</h3>
            <p>Welcome to the Intelligent Reporting suite...</p>
            
            <div id="ai-chat-history" style="border: 1px solid #ccc; padding: 1rem; min-height: 150px; overflow-y: auto; background: #f9f9f9;">
                </div>
            
            <button onclick="generateAiReport()">Generate Draft Report</button>
            <label>Audience Tone</label>
            <select id="audience-tone">
                <option>Technical (Internal)</option>
                <option>Public</option>
                <option>Investor</option>
            </select>
            <button onclick="addVisualisation()">Add Visualisation</button>
            <button onclick="enrichData()">Enrich with Data</button>
        </section>

        <section id="visualisation-view" class="view">
            <h2>Configure Project Visualisation</h2>
            <p>Review your project settings before publishing...</p>
            <button onclick="showView('dashboard-view')">Back to Dashboard</button>

            <nav id="visualisation-nav"></nav>
            <div id="visualisation-content"></div>

            <h3>Site Map (Figure 1)</h3>
            <img src="https://placehold.co/600x400/e2e8f0/475569?text=Rossbehy+Overview+Map+(Fig+1)" alt="Site Map Placeholder" onclick="showMapDetail(event)">
            <p>Click to explore</p>
            <div id="map-detail-info"></div>
            
            <h3>Full Assessment Document (Excerpt)</h3>
            <div id="rossbehy-doc-content">
                </div>
        </section>

        <section id="settings-view" class="view">
            <h2>Settings</h2>
            
            <h3>GIS Integration</h3>
            <p>Connect to your preferred GIS tool...</p>
            
            <div id="gis-initial-choice">
                <div onclick="showGisConnection('ArcGIS')" style="padding: 1rem; background: #fff; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/ArcGIS_logo.png/220px-ArcGIS_logo.png" alt="ArcGIS Logo" style="width:100px">
                    <h4>ArcGIS</h4>
                    <p>Connect to the Esri Geospatial Cloud.</p>
                </div>
                <div onclick="showGisConnection('QGIS')" style="padding: 1rem; background: #fff; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/QGIS_Logo_new.svg/200px-QGIS_Logo_new.svg.png" alt="QGIS Logo" style="width:100px">
                    <h4>QGIS</h4>
                    <p>Connect using the open-source GIS leader.</p>
                </div>
            </div>

            <div id="gis-connection-view" class="hidden">
                <h4 id="gis-connection-title">Connect to ...</h4>
                <button onclick="showInitialGisChoice()">Back to GIS Options</button>
                <h4>Connection Details</h4>
                <label>API Key</label> <input type="text">
                <label>User / Client Key</label> <input type="text">

                <h4>Select Fields to Extract</h4>
                <div id="gis-field-list"></div>
                
                <button>Connect & Extract Data</button>
            </div>
        </section>

        <section id="survey-form-view" class="view">
            <h2 id="survey-form-title">Survey</h2>
            <p id="survey-form-project-name">Project...</p>
            <p id="survey-form-site-name">Site...</p>
            <input type="hidden" id="survey-id-input">

            <div id="mobile-survey-form">
                <h3>Habitat Mapping</h3>
                <label>Habitat Type (Irish Classification)</label> <input type="text" id="habitat-type" value="GS2 - Dry meadows and grassy verges">
                <label>Notes on Habitat Condition</label> <textarea id="habitat-notes"></textarea>

                <h3>Species Records</h3>
                <label>Species Observed</label> <input type="text" id="species-observed">
                <label>Notes</label> <textarea id="species-notes"></textarea>

                <h3>GPS-tagged Photos</h3>
                <div id="photo-preview-container">
                    <input type="file" onchange="displayPhotoPreview(event)">
                </div>
                
                <button onclick="submitSurvey()" style="margin-top: 1rem;">Submit Survey Data</button>
            </div>
        </section>
        
        <section id="assessment-detail-view" class="view">
            <button onclick="showView('tasks-view')">Back to Tasks</button>
            <h2 id="assessment-site-name">...</h2>
            <p id="assessment-site-code">...</p>
            <span id="assessment-status-badge" class="status-badge"></span>
            <p>County: <span id="assessment-county"></span></p>
            <p>Area: <span id="assessment-area"></span> ha</p>
            
            <h3>Habitats</h3>
            <ul id="assessment-habitats"></ul>
            <h3>Species</h3>
            <ul id="assessment-species"></ul>
            
            <h3>Tables</h3>
            <table id="rossbehy-table-1" class="projects-table"></table>
            <table id="rossbehy-table-2" class="projects-table"></table>
            <table id="rossbehy-table-3" class="projects-table"></table>
        </section>

        <div id="new-survey-project-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3>Create New Survey Project</h3>
                <p>This will create a new project container for your survey.</p>
                <label>Project Name</label> <input type="text" id="new-project-name">
                <label>Client Name</label> <input type="text" id="new-client-name">
                <input type="hidden" id="new-survey-template-id-input">
                <button onclick="hideNewSurveyProjectModal()">Cancel</button>
                <button onclick="createNewSurveyFromModal()">Create Project</button>
            </div>
        </div>

        <div id="assign-survey-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3>Survey Ready to Assign</h3>
                <p>Share this secure link with the field ecologist.</p>
                <input type="text" id="survey-link-input" readonly>
                <button onclick="copySurveyLink()">Copy Link</button>
                <button onclick="hideAssignSurveyModal()">Close</button>
            </div>
        </div>

        <div id="toast" class="toast">
            <span id="toast-icon" style="margin-right: 0.5rem;"></span>
            <span id="toast-message"></span>
        </div>
    </main>

    <script>
    [cite_start]// --- DATA STORE (Mock Database & Local Storage) --- [cite: 67-74]
    let db;
    const defaultDb = { 
        projects: [ 
            { id: 1, name: "Lough Ennell SAC", client: "NPWS", code: "NPWS-001-25" }, 
        ], 
        surveys: [ 
            { id: 101, projectId: 1, siteName: "Site A - Woodland", template: "PEA", status: "Completed", data: { habitat: "WD1 - Oak-birch-holly woodland", notes: "Mature oak canopy, limited undergrowth.", species: "Sciurus vulgaris (Red Squirrel)", photo: "https_//placehold.co/600x400/a3e635/ffffff?text=Woodland+Canopy" } }, 
            { id: 102, projectId: 1, siteName: "Site B - River Crossing", template: "EcIA", status: "In Progress", data: {} }, 
        ], 
        team: [ 
            { name: "Dr. Aoife Murphy", email: "aoife.murphy@dulra.ie", role: "Principal Ecologist" }, 
            { name: "Cian O'Donnell", email: "cian.odonnell@dulra.ie", role: "Field Ecologist" }, 
            { name: "Siobhán Kelly", email: "siobhan.kelly@dulra.ie", role: "GIS Specialist" } 
        ] 
    }; 
    function saveData() { 
        localStorage.setItem('dulraDb', JSON.stringify(db));
    } 
    function loadData() { 
        const storedDb = localStorage.getItem('dulraDb'); 
        db = storedDb ? JSON.parse(storedDb) : JSON.parse(JSON.stringify(defaultDb));
    }
    const surveyTemplates = [ 
        { id: "PEA", name: "Preliminary Ecological Appraisal", description: "A baseline ecological assessment.", icon: "clipboard-list" }, 
        { id: "EcIA", name: "Ecological Impact Assessment", description: "Assess potential project impacts.", icon: "alert-triangle" }, 
        { id: "NIS", name: "Natura Impact Statement", description: "For projects affecting Natura 2000 sites.", icon: "shield-check" }, 
        { id: "AA", name: "Appropriate Assessment Screening", description: "Initial screening for AA.", icon: "search" }, 
        { id: "Bat", name: "Bat Survey", description: "Surveys for bat activity and roosts.", icon: "moon" }, 
        { id: "Bird", name: "Bird Survey", description: "Various methods for avian populations.", icon: "bird" }, 
        { id: "Habitat", name: "Habitat & Botanical Survey", description: "Mapping and assessing habitats.", icon: "leaf" }, 
        { id: "Invasive", name: "Invasive Species Survey", description: "Mapping and management plans.", icon: "bug" }, 
        { id: "ECoW", name: "ECoW Report", description: "Ecological Clerk of Works monitoring.", icon: "user-check" } 
    ];
    let currentProjectId = null; 
    let currentProjectTab = 'surveys'; 
    let currentVisualisationTab = 'basic'; 
    let chartInstances = {};
    // To hold chart objects 
    let currentTasksTab = 'assessments'; 
    let currentSiteStatusTab = 'sac';
    
    [cite_start]// --- UPDATED VIEW MANAGEMENT [cite: 74-79] --- 
    function showView(viewId, param = null) {
        // Hide all views
        const allViews = document.querySelectorAll('.view');
        allViews.forEach(view => view.classList.remove('active-view'));

        // Show the requested view
        const activeView = document.getElementById(viewId);
        if (activeView) {
            activeView.classList.add('active-view');
        } else {
            console.error('View not found:', viewId);
            document.getElementById('dashboard-view').classList.add('active-view'); // Fallback
        }
        
        // Scroll to top of main content
        const mainContent = document.querySelector('main');
        if (mainContent) mainContent.scrollTo(0, 0);

        // Call render functions based on the view being shown
        if (viewId === 'dashboard-view') renderDashboard();
        if (viewId === 'tasks-view') renderTasksView();
        if (viewId === 'my-surveys-view') renderProjects(); // This renders the survey list
        if (viewId === 'projects-page-view') renderProjectsPage(); // This renders the new Projects page
        
        if (viewId === 'project-detail-view') {
            currentProjectId = param;
            renderProjectDetails(param);
        }
        if (viewId === 'survey-form-view') renderSurveyForm(param);
        if (viewId === 'survey-template-view') renderSurveyTemplates();
        if (viewId === 'eiar-editor-view') renderEiarEditor(param || { projectId: currentProjectId });
        if (viewId === 'ecow-editor-view') renderEcowEditor(param || { projectId: currentProjectId });
        
        if (viewId === 'settings-view') showInitialGisChoice();
        
        if (viewId === 'desktop-research-view') {
            const resultsContainer = document.getElementById('datamine-results-container');
            if (resultsContainer) resultsContainer.classList.add('hidden');
        }
        
        if (viewId === 'team-view') renderTeamView();
        if (viewId === 'impact-view') updateImpactCalculation();
        if (viewId === 'visualisation-view') renderVisualisationView();
        if (viewId === 'assessment-detail-view') renderAssessmentDetailView(param);
    } 
    
    [cite_start]// --- ROUTING (based on URL) --- [cite: 79-82]
    function handleRouting() { 
        const params = new URLSearchParams(window.location.search); 
        const surveyId = params.get('survey');
        if(surveyId) { 
            const survey = db.surveys.find(s => s.id == surveyId); 
            if(survey) { 
                showView('survey-form-view', survey.id); 
            } else { 
                showView('dashboard-view');
            // Fallback if survey ID invalid 
            } 
        } else { 
            showView('dashboard-view');
        // Default to dashboard 
        } 
    } 
    
    // --- RENDERING FUNCTIONS --- 
    [cite_start]function renderSurveyTemplates() { // [cite: 82-84]
        const container = document.querySelector('#survey-template-grid');
        if (!container) return;
        container.innerHTML = surveyTemplates.map(template => ` 
            <div onclick="startSurveyFromTemplate('${template.id}')" style="background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;"> 
                <div class="flex-1"> 
                    <i data-lucide="${template.icon}" class="w-8 h-8 text-accent mb-3"></i> 
                    <h3 class="font-bold text-lg text-secondary">${template.name}</h3> 
                    <p class="text-sm text-gray-500 mt-1">${template.description}</p> 
                </div> 
                <button class="mt-4 text-sm font-semibold text-accent text-left">Start Survey &rarr;</button> 
            </div> 
        `).join('');
        lucide.createIcons(); 
    } 
    
    [cite_start]function renderProjects() { // [cite: 84-86]
        const list = document.getElementById('project-list'); 
        if (!list) return;
        if (db.projects.length === 0) { 
            list.innerHTML = `<div style="text-align: center; padding: 2rem; background: #fff; border-radius: 8px;"> 
                <i data-lucide="folder-search" style="width: 48px; height: 48px; margin: auto; color: #ccc;"></i> 
                <h3>No surveys yet</h3> 
                <p>Get started by creating your first survey.</p> 
                <button onclick="showView('survey-template-view')">Create Survey</button> 
            </div>`;
            lucide.createIcons(); 
            return; 
        } 
        list.innerHTML = db.projects.map(p => { 
            const projectSurveys = db.surveys.filter(s => s.projectId === p.id); 
            const completed = projectSurveys.filter(s => s.status === 'Completed').length; 
            return ` 
            <div style="background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;" onclick="showView('project-detail-view', ${p.id})"> 
                <div style="display: flex; justify-content: space-between;"> 
                    <div> 
                        <h3>${p.name}</h3> 
                        <p>${p.client}</p> 
                    </div> 
                    <span style="font-size: 0.75rem; background: #eee; padding: 0.25rem 0.5rem; border-radius: 12px; height: fit-content;">${p.code}</span> 
                </div> 
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f3f3f3;"> 
                    <p>${completed} of ${projectSurveys.length} surveys completed.</p> 
                    <div style="width: 100%; background: #eee; border-radius: 4px; height: 8px;"> 
                        <div style="background: #FB923C; height: 8px; border-radius: 4px; width: ${projectSurveys.length > 0 ? (completed / projectSurveys.length) * 100 : 0}%"></div> 
                    </div> 
                </div> 
            </div> 
            `}).join('');
    } 
    
    // --- NEW FUNCTION TO RENDER DYNAMIC PROJECTS PAGE ---
    function renderProjectsPage() {
        const tableBody = document.getElementById('projects-table-body');
        if (!tableBody) return; // Exit if element isn't on the page

        [cite_start]let assessmentsData = parseCsv(assessmentsCsvData); // [cite: 174-176]
        const rossbehyAssessment = { SITECODE: '13', SITE_NAME: 'Rossbehy', Status: 'Completed', COUNTY: 'Kerry', HA: '91.71', Link: '#' }; //
        if (!assessmentsData.some(item => item.SITECODE === '13')) { //
            assessmentsData.push(rossbehyAssessment);
        }

        let html = '';
        
        // Helper function to get progress bar details
        const getProgressDetails = (siteName) => {
            // We have no real progress data, so we create a stable "random" value
            // based on the site name's length to make it look consistent.
            const progress = (siteName.length * 7) % 100 + 1; 
            
            let status = '';
            if (progress <= 25) status = 'Desktop research';
            else if (progress <= 50) status = 'Field survey';
            else if (progress <= 75) status = 'Report';
            else status = 'Final data deliveries';
            
            return { progress, status };
        };

        assessmentsData.forEach(row => {
            const { progress, status } = getProgressDetails(row.SITE_NAME);
            
            html += `
                <tr>
                    <td>${row.SITE_NAME}</td>
                    <td>${row.SITECODE}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${progress}%"></div>
                        </div> ${progress}%
                    </td>
                    <td>${status}</td>
                </tr>
            `;
        });

        tableBody.innerHTML = html;
    }
    
    [cite_start]// --- FIX: RENDER PROJECT DETAILS --- [cite: 86-87]
    function renderProjectDetails(projectId) { 
        const project = db.projects.find(p => p.id === projectId); 
        if (!project) {
            showView('my-surveys-view');
            showToast("Error: Project not found", "error");
            return;
        }
        document.getElementById('project-title').textContent = project.name; 
        document.getElementById('project-client').textContent = project.client;
        document.getElementById('project-code').textContent = project.code; 
        renderProjectTabs(projectId); 
        renderProjectTabContent(projectId); 
    } 
    
    [cite_start]function renderEiarEditor(params) { // [cite: 87-89]
        if (!params) {
            showToast("No project selected", "error");
            showView('my-surveys-view');
            return;
        }
        const { projectId } = params;
        const project = db.projects.find(p => p.id === projectId); 
        if (!project) return;
        currentProjectId = projectId; 
        document.getElementById('eiar-editor-project-name').textContent = `Project: ${project.name}`;
    } 
    
    [cite_start]function renderEcowEditor(params) { // [cite: 89-91]
         if (!params) {
            showToast("No project selected", "error");
            showView('my-surveys-view');
            return;
        }
        const { projectId } = params; 
        const project = db.projects.find(p => p.id === projectId);
        if (!project) return;
        currentProjectId = projectId; 
        document.getElementById('ecow-editor-project-name').textContent = `Project: ${project.name}`; 
    } 
    
    [cite_start]function renderTeamView() { // [cite: 91-92]
        const list = document.getElementById('team-list');
        if (!list) return;
        list.innerHTML = db.team.map(member => ` 
            <tr> 
                <td class="p-4 font-medium text-secondary">${member.name}</td> 
                <td class="p-4 text-gray-600">${member.email}</td> 
                <td class="p-4"><span class="status-badge ${member.role === 'Principal Ecologist' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${member.role}</span></td> 
                <td class="p-4"><button class="text-gray-400 hover:text-accent"><i data-lucide="more-horizontal"></i></button></td> 
            </tr> 
        `).join('');
        lucide.createIcons(); 
    } 
    
    [cite_start]function renderProjectTabs(projectId) { // [cite: 92-94]
        const tabs = [ { id: 'surveys', name: 'Surveys' } ]; 
        const tabsContainer = document.getElementById('project-tabs');
        if (!tabsContainer) return;
        tabsContainer.innerHTML = tabs.map(tab => ` 
            <button onclick="setProjectTab('${tab.id}')" style="border-bottom: 2px solid ${currentProjectTab === tab.id ? '#FB923C' : 'transparent'}; padding: 0.5rem; background: none; border: none; cursor: pointer; font-size: 1rem;"> 
                ${tab.name} 
            </button> 
        `).join('');
    } 
    
    [cite_start]function setProjectTab(tabId) { // [cite: 94-95]
        currentProjectTab = tabId; 
        renderProjectTabs(currentProjectId); 
        renderProjectTabContent(currentProjectId); 
    } 
    
    [cite_start]function renderProjectTabContent(projectId) { // [cite: 95-98]
        const contentContainer = document.getElementById('project-tab-content');
        if (!contentContainer) return;
        if (currentProjectTab === 'surveys') { 
            const projectSurveys = db.surveys.filter(s => s.projectId === projectId);
            contentContainer.innerHTML = ` 
                <div id="survey-list" class="space-y-4"> 
                    ${projectSurveys.length > 0 ?
                    projectSurveys.map(s => { 
                        const statusColor = getStatusColorClass(s.status); // Use helper 
                        return ` 
                        <div style="border: 1px solid #eee; padding: 1rem; border-radius: 4px; background: #fff; display: flex; justify-content: space-between; align-items: center;"> 
                            <div> 
                                <p style="font-weight: 600;">${s.siteName} <span style="font-weight: 400; font-size: 0.8rem;">(${s.template})</span></p> 
                                <span class="status-badge" style="${statusColor}">${s.status}</span> 
                            </div> 
                            <div> 
                                ${s.status === 'Ready' ? `<button onclick="assignSurvey(${s.id})">Assign</button>` : ''} 
                                ${s.status === 'Completed' ? `<button onclick="generateReport(${s.id})">Generate Report</button>` : ''} 
                            </div> 
                        </div>`; 
                    }).join('') : '<p>No surveys created for this project yet.</p>'} 
                </div> 
            `;
        } 
        lucide.createIcons(); 
    } 
    
    [cite_start]function renderSurveyForm(surveyId) { // [cite: 98-100]
        const survey = db.surveys.find(s => s.id == surveyId);
        if (!survey) return showView('dashboard-view');
        const project = db.projects.find(p => p.id === survey.projectId); 
        const template = surveyTemplates.find(t => t.id === survey.template); 
        document.getElementById('survey-id-input').value = survey.id;
        document.getElementById('survey-form-title').textContent = template.name; 
        document.getElementById('survey-form-project-name').textContent = project.name; 
        document.getElementById('survey-form-site-name').textContent = survey.siteName; 
    } 
    
    [cite_start]// --- Assessment Detail View --- [cite: 100-122]
    function renderAssessmentDetailView(params) { 
        if (!params) return showView('tasks-view');
        const { siteCode } = params;
        const assessments = parseCsv(assessmentsCsvData);
        const siteData = assessments.find(site => site.SITECODE == siteCode) || { SiteName: 'Rossbehy', SITECODE: '13', Status: 'Completed', COUNTY: 'Kerry', HA: '91.71' };
        
        document.getElementById('assessment-site-name').textContent = siteData.SiteName || siteData.SITE_NAME; 
        document.getElementById('assessment-site-code').textContent = `Site Code: ${siteData.Sitecode || siteData.Site_Code || siteData.SITECODE}`; 
        document.getElementById('assessment-county').textContent = siteData.COUNTY || 'N/A';
        document.getElementById('assessment-area').textContent = siteData.HA || 'N/A'; 
        const statusBadge = document.getElementById('assessment-status-badge'); 
        statusBadge.textContent = siteData.Status || 'Unknown'; 
        statusBadge.className = `status-badge`;
        statusBadge.style = getStatusColorClass(siteData.Status);
        const habitatsList = document.getElementById('assessment-habitats'); 
        const speciesList = document.getElementById('assessment-species');
        const table1 = document.getElementById('rossbehy-table-1'); 
        const table2 = document.getElementById('rossbehy-table-2'); 
        const table3 = document.getElementById('rossbehy-table-3'); 
        
        [cite_start]if (siteCode == 13) { // [cite: 107-119]
            habitatsList.innerHTML = ` 
                <li>Fixed coastal dunes... (2130)</li> 
                <li>Embryonic shifting dunes (2110)</li> 
                <li>Shifting dunes... (2120)</li> 
                <li>Atlantic salt meadows (1330)</li> 
                <li>Mediterranean salt meadows (1410)</li> 
            `;
            speciesList.innerHTML = ` 
                <li>Light-bellied Brent Goose... [A046]</li> 
                <li>Common Scoter... [A065]</li> 
                <li>Red-breasted Merganser... [A069]</li> 
            `;
            table1.innerHTML = ` 
                <thead><tr><th>Habitat Code</th><th>Habitat Name</th><th>Area (ha)</th><th>Subsite</th></tr></thead> 
                <tbody> 
                    <tr><td>2130</td><td>Fixed coastal dunes*</td><td>10.39</td><td>1</td></tr> 
                    <tr><td>2110</td><td>Embryonic shifting dunes</td><td>0.09</td><td>1</td></tr> 
                </tbody> 
            `;
            table2.innerHTML = ` 
                <thead><tr><th>Species Code</th><th>Species Name</th><th>Population/Range</th><th>Subsite</th></tr></thead> 
                <tbody> 
                    <tr><td>A046</td><td>Light-bellied Brent Goose</td><td>Population</td><td>-</td></tr>
                </tbody> 
            `;
            table3.innerHTML = ` 
                <thead><tr><th>Habitat Code</th><th>Conservation Objective</th><th>Target</th></tr></thead> 
                <tbody> 
                    <tr><td>2130</td><td>Restore favourable...</td><td>Restore</td></tr> 
                    <tr><td>2110</td><td>Maintain favourable...</td><td>Maintain</td></tr> 
                </tbody> 
            `;
        [cite_start]} else { // [cite: 119-122]
            habitatsList.innerHTML = `<li>Placeholder Habitat 1</li>`; 
            speciesList.innerHTML = `<li>Placeholder Species A</li>`;
            table1.innerHTML = `<tbody><tr><td>No data available for this site.</td></tr></tbody>`; 
            table2.innerHTML = `<tbody><tr><td>No data available for this site.</td></tr></tbody>`;
            table3.innerHTML = `<tbody><tr><td>No data available for this site.</td></tr></tbody>`; 
        } 
    } 
    
    [cite_start]function showMapDetail(event) { // [cite: 122-125]
        const mapInfo = document.getElementById('map-detail-info'); 
        if (!mapInfo) return;
        const targetElement = event.target.closest('\[data-info\]');
        if (targetElement) { 
            mapInfo.textContent = `You clicked on: ${targetElement.dataset.info}`;
        } else { 
            mapInfo.textContent = `Exploring the map...`; 
        } 
        setTimeout(() => { 
            mapInfo.textContent = ''; 
        }, 2500);
    } 
    
    [cite_start]// --- MODAL CONTROLS --- [cite: 125-128]
    const newSurveyProjectModal = document.getElementById('new-survey-project-modal'); 
    const assignSurveyModal = document.getElementById('assign-survey-modal'); 
    // REMOVED: const assignThirdPartyModal 
    
    function showNewSurveyProjectModal() { 
        newSurveyProjectModal.classList.remove('hidden'); 
    } 
    function hideNewSurveyProjectModal() { 
        newSurveyProjectModal.classList.add('hidden'); 
    } 
    function showAssignSurveyModal() { 
        assignSurveyModal.classList.remove('hidden'); 
    } 
    function hideAssignSurveyModal() { 
        assignSurveyModal.classList.add('hidden');
    } 
    // REMOVED: showAssignToThirdPartyModal()
    // REMOVED: hideAssignToThirdPartyModal()
    
    [cite_start]// --- TOAST NOTIFICATION --- [cite: 128-132]
    function showToast(message, type = 'success') { 
        const toast = document.getElementById('toast'); 
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon'); 
        if (!toast || !toastMessage || !toastIcon) return;
        toastMessage.textContent = message; 
        toast.className = 'toast show';
        if (type === 'success') { 
            toast.style.backgroundColor = '#10B981';
            toast.style.color = 'white';
            toastIcon.innerHTML = '<i data-lucide="check-circle"></i>';
        } else { // error 
            toast.style.backgroundColor = '#EF4444';
            toast.style.color = 'white';
            toastIcon.innerHTML = '<i data-lucide="alert-circle"></i>';
        } 
        lucide.createIcons(); 
        setTimeout(() => { 
            toast.classList.remove('show'); 
        }, 3000);
    } 
    
    [cite_start]// --- GIS VIEW CONTROLS --- [cite: 132-145]
    const gisFields = [ 
        { id: 'foss_qualifi', name: 'FOSS_QUALIFI', description: 'Qualifier code for Guide to Habitats classification subtypes.' },
        { id: 'add_hab', name: 'ADD_HAB', description: 'Field for secondary habitat classification schemes.' },
        { id: 'foss_name', name: 'FOSS_NAME', description: 'Habitat name corresponding to the Guide to Habitats code.' },
        { id: 'area_length', name: 'AREA / LENGTH', description: 'Total area (m²) for polygons or length (m) for polylines.' }
        // ... (other fields)
    ];
    
    function showGisConnection(toolName) { 
        document.getElementById('gis-initial-choice').classList.add('hidden'); 
        document.getElementById('gis-connection-view').classList.remove('hidden'); 
        document.getElementById('gis-connection-title').textContent = `Connect to ${toolName}`; 
        const fieldList = document.getElementById('gis-field-list');
        if (!fieldList) return;
        fieldList.innerHTML = gisFields.map(field => ` 
            <div style="margin-top: 0.5rem;"> 
                <input id="${field.id}" name="${field.id}" type="checkbox" checked> 
                <label for="${field.id}" style="font-weight: 600;">${field.name}</label> 
                <p style="font-size: 0.8rem; color: #555; margin: 0;">${field.description}</p> 
            </div> 
        `).join('');
    } 
    
    function showInitialGisChoice() { 
        document.getElementById('gis-connection-view').classList.add('hidden'); 
        document.getElementById('gis-initial-choice').classList.remove('hidden'); 
    } 
    
    [cite_start]// --- DATA MINE CONTROLS --- [cite: 145-148]
    function performDataMineSearch() { 
        const resultsContainer = document.getElementById('datamine-results-container');
        const loading = document.getElementById('datamine-loading'); 
        const content = document.getElementById('datamine-results-content'); 
        if (!resultsContainer || !loading || !content) return;
        resultsContainer.classList.remove('hidden'); 
        content.classList.add('hidden'); 
        loading.classList.remove('hidden');
        // Simulate a network request 
        setTimeout(() => { 
            loading.classList.add('hidden'); 
            content.classList.remove('hidden'); 
        }, 1500);
    } 
    
    [cite_start]// --- DYNAMIC FIELD SURVEY ENTRY --- [cite: 148-156]
    function addHabitatEntry() { 
        const container = document.getElementById('habitat-entries'); 
        if (!container) return; // FIX
        const newEntry = document.createElement('div');
        newEntry.style.border = "1px solid #eee"; newEntry.style.padding = "1rem"; newEntry.style.background = "#fff";
        newEntry.innerHTML = ` 
            <div> 
                <label>Habitat Code</label> <input type="text" placeholder="e.g., GS2"> 
            </div> 
            <div> 
                <label>Habitat Name</label> <input type="text" placeholder="e.g., Dry meadows"> 
            </div> 
            <div> 
                <label>Notes</label> <textarea rows="3"></textarea> 
            </div> 
        `;
        container.appendChild(newEntry); 
    } 
    
    function addFaunaSighting() { 
        const container = document.getElementById('fauna-entries'); 
        if (!container) return; // FIX
        const newEntry = document.createElement('div'); 
        newEntry.style.border = "1px solid #eee"; newEntry.style.padding = "1rem"; newEntry.style.background = "#fff";
        newEntry.innerHTML = ` 
            <div> 
                <label>Species</label> <input type="text" placeholder="e.g., Otter"> 
            </div> 
            <div> 
                <label>Number</label> <input type="number" value="1"> 
            </div> 
            <div> 
                <label>Evidence</label> <input type="text" placeholder="e.g., Spraint"> 
            </div> 
            <div> 
                <label>Notes</label> <textarea rows="3"></textarea> 
            </div> 
            <div> 
                <label>Image</label> 
                <div><input type="file"></div> 
            </div> 
        `;
        container.appendChild(newEntry); 
        lucide.createIcons(); 
    } 
    
    function addFloraRecord() { 
        const container = document.getElementById('flora-entries'); 
        if (!container) return; // FIX
        const newEntry = document.createElement('div'); 
        newEntry.style.border = "1px solid #eee"; newEntry.style.padding = "1rem"; newEntry.style.background = "#fff";
        newEntry.innerHTML = ` 
            <div> 
                <label>Species Name</label> <input type="text" placeholder="e.g., Bluebell"> 
            </div> 
            <div> 
                <label>DAFOR Scale</label> 
                <select> 
                    <option>Dominant</option> <option>Abundant</option> <option>Frequent</option> <option>Occasional</option> <option>Rare</option> 
                </select> 
            </div> 
            <div> 
                <label>Notes</label> <textarea rows="3"></textarea> 
            </div> 
            <div> 
                <label>Image</label> 
                <div><input type="file"></div> 
            </div> 
        `; 
        container.appendChild(newEntry); 
        lucide.createIcons();
    } 
    
    [cite_start]// --- TEMPLATE EDITOR --- [cite: 156-161]
    function addTemplateElement(type) { 
        const editor = document.getElementById('custom-template-editor');
        if (!editor) return;
        const newElement = document.createElement(type === 'heading' ? 'h4' : 'p'); 
        newElement.setAttribute('contenteditable', 'true');
        if (type === 'heading') { 
            newElement.textContent = 'New Editable Heading';
        } else { 
            newElement.textContent = 'New editable paragraph. Start typing...'; 
        } 
        editor.appendChild(newElement); 
        newElement.focus();
    } 
    
    function saveCustomTemplate() { 
        showToast('Custom template saved!'); 
        showView('survey-template-view');
    } 
    
    [cite_start]// --- UPDATED IMPACT CALCULATION --- [cite: 161-165]
    function updateImpactCalculation() {
        // Ensure all elements exist before running
        if (!document.getElementById('crm-flights-height')) return;

        // Read Stage 1 & 2 Inputs
        const flights = parseFloat(document.getElementById('crm-flights-height').value) || 0;
        const hours = parseFloat(document.getElementById('crm-vp-hours').value) || 0;
        
        // Read Stage 3 Inputs
        const birdLength = parseFloat(document.getElementById('crm-bird-length').value) || 0;
        const rotorDiameter = parseFloat(document.getElementById('crm-rotor-diameter').value) || 0;
        
        // Read Stage 4 & 5 Inputs
        const opTime = parseFloat(document.getElementById('crm-optime').value) / 100 || 0.85;
        const avoidance = parseFloat(document.getElementById('crm-avoidance').value) / 100 || 0.98;

        // --- Perform Calculations ---
        
        // (Simple demo formula to replace hard-coded 'passages = 11.19')
        // This is a placeholder; a real model is far more complex.
        const passages = (flights > 0 && hours > 0) ? (flights / hours) * 24 * 30 : 0;
        
        // (Simple demo formula to replace hard-coded 'probability = 0.179')
        // This is a placeholder.
        const probability = (birdLength > 0 && rotorDiameter > 0) ? (birdLength / rotorDiameter) * 0.35 : 0;
        
        // --- Update UI Outputs ---
        document.getElementById('crm-passages-result').textContent = passages.toFixed(2);
        document.getElementById('crm-probability-result').textContent = (probability * 100).toFixed(1) + '%';
        
        [cite_start]// --- Final Calculation (from original) [cite: 164-165] ---
        const adjustedProbability = probability * opTime;
        const finalCollisions = passages * adjustedProbability * (1 - avoidance);
        document.getElementById('crm-final-result').textContent = finalCollisions.toFixed(2);
    }
    
    [cite_start]// --- DASHBOARD --- [cite: 165-171]
    function renderDashboard() { 
        if (typeof Chart === 'undefined' || typeof ChartDataLabels === 'undefined') {
            console.error('Chart.js or ChartDataLabels is not loaded.');
            return;
        }
        // Chart.register(ChartDataLabels); // Register plugin - may be auto-registered
        destroyCharts(); // Clear old charts
        renderStatusChart('actions-chart', 'Action Status', [5, 3, 8, 12]);
        renderStatusChart('surveys-chart', 'Assessment Status', [3, 1, 2, 8]); 
        renderSiteStatusTabs(); 
        renderSiteStatusTabContent();
    } 
    
    function destroyCharts() { 
        Object.values(chartInstances).forEach(chart => { 
            if (chart) chart.destroy(); 
        }); 
        chartInstances = {};
    } 
    
    function renderStatusChart(canvasId, label, data) { 
        const ctx = document.getElementById(canvasId);
        if (!ctx) return; // Exit if canvas not found
        const total = data.reduce((a, b) => a + b, 0);
        chartInstances[canvasId] = new Chart(ctx.getContext('2d'), { 
            type: 'doughnut', 
            data: { 
                labels: ['Not Assigned', 'Pending', 'In Progress', 'Completed'], 
                datasets: [{ 
                    label: label, 
                    data: data, 
                    backgroundColor: ['#E5E7EB', '#FBBF24', '#3B82F6', '#10B981'], // Grey, Yellow, Blue, Green 
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { position: 'bottom' }, 
                    tooltip: { 
                        callbacks: { 
                            label: function(context) { 
                                let label = context.label || ''; 
                                if (label) { label += ': '; } 
                                const value = context.raw; 
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%'; 
                                label += `${value} (${percentage})`; 
                                return label; 
                            } 
                        } 
                    }, 
                    datalabels: { 
                        formatter: (value, ctx) => { 
                            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); 
                            let percentage = sum > 0 ? (value * 100 / sum).toFixed(0) + "%" : '0%'; 
                            return percentage; 
                        }, 
                        color: '#fff', 
                    } 
                } 
            },
            plugins: [ChartDataLabels] // Register plugin for this chart
        });
    } 
    
    [cite_start]// --- CSV DATA --- [cite: 171-179]
    // (Keeping data minimal for example)
    const sacConditionsCsv = `Site Name ,Site code,Last Upate ,Habitats Health ,Species Health 
River Barrow and River Nore SAC,2162,June 2025,Inadequate,Bad 
Hook Head SAC,764,January 2025,Favourable,Favourable 
Belgica Mound Province SAC,2327,January 2025,Inadequate,Inadequate 
West Connacht Coast SAC,2998,January 2025,Bad,Favourable`;
    
    const spaConditionsCsv = `Site Name ,Site Code ,Last Updated,Habitats Health ,Species Health 
Lady's Island Lake SPA,4009,July 2025,Favourable,Favourable 
Termoncarragh Lake and Annagh Machair SPA,4093,June 2025,Inadequate,Favourable`;
    
    const nhaConditionsCsv = `Site Name ,Site Code ,Last Updated,Habitats Health ,Species Health 
Slieve Rushen Bog NHA,9,Not Assigned,Cavan,674.7 
Inishduff NHA,151,Pending,Donegal,46.5`;
    
    const assessmentsCsvData = `SITECODE,SITE_NAME,Status,COUNTY,HA,Link to Survey 
9,Slieve Rushen Bog NHA,Not Assigned,Cavan,674.7,https_//...
151,Inishduff NHA,Pending,Donegal,46.5,https_//...
184,Roaninish NHA,In Progress,Donegal,145.8,https_//...
220,Lough Namucka Bog NHA,Completed,Galway,221.0,https_//...
6, Killyconny Bog (Cloghbally) SAC,Pending, Cavan, 284, 
7, Lough Oughter and Associated Loughs SAC, Completed, Galway, 898, 
4, Ballyallia Lake SAC, Completed, Galway, 897, 
10, Ballycullinan Lake SAC, Completed, Galway, 798, 
20, Black Head/Poulsallagh Complex, Completed, Donegal,199, 
90, Danes Hole Poulnalecka SAC, Completed, Mayo, 7889 
32, Dromore Woods & Loughs, Completed, Cork, 8978, 
37, Pouladatig Cave 1999, Completed, Cork, 879, 
51, Lough Gash Turlough SAC, Completed, Cork, 878, 
54, Moneen Mountain 1997, Completed, Limerick, 9889, 
57, Moyree River System, Completed, Cork, 878, 
64, Poulnagordon Cave (Quin) SAC, Completed, Cork, 878, 
77, Ballymacoda(Clonpriest and Pillmore)SAC, Completed, Cork, 7768, 
90, Glengarriff Harbour and Woodland, Completed, Cork, 756, 
91, Clonakilty Bay SAC, Completed, Mayo, 435, 
93, Caha Mountains SAC, Completed, Donegal, 426, 
97, Lough Hyne Nature Reserve and Environs SAC, Completed, Sligo, 549, 
101, Roaringwater Bay and Islands SAC, Completed, Sligo,470, 
106, St. Gobnet's Wood SAC, Completed, Donegal,216, 
109, Three Castle Head to Mizen Head, Completed, Donegal,540, 
111, Aran Island (Donegal) Cliffs SAC, Completed, Donegal, 613,`;
    
    const actionsCsvData = `SITECODE,SITE_NAME,Status,COUNTY,Action Type,Link to Survey 
245,Clooncullaun Bog NHA,In Progress,Galway,Site and habitat management,https_//...
247,Slieve Bog NHA,Completed,Galway,Species protection,https_//...`;
    
    [cite_start]// --- HELPER FUNCTIONS --- [cite: 179-191]
    function parseCsv(csvString) { 
        const rows = csvString.trim().split('\n'); 
        const headers = rows.shift().split(',').map(h => h.trim().replace(/ /g, '_')); // Replace spaces for easier access
        return rows.map(row => { 
            const values = row.split(','); 
            return headers.reduce((obj, header, index) => { 
                obj[header] = values[index] ? values[index].trim() : ''; 
                return obj; 
            }, {}); 
        });
    } 
    
    [cite_start]function getStatusColorClass(status) { // [cite: 181-184]
        if (!status) return 'background: #f3f4f6; color: #374151;'; 
        const lowerStatus = status.toLowerCase(); 
        if (lowerStatus === 'completed') return 'background: #dcfce7; color: #166534;'; // Green
        if (lowerStatus === 'in progress') return 'background: #dbeafe; color: #1e40af;'; // Blue
        if (lowerStatus === 'pending') return 'background: #fef9c3; color: #a16207;'; // Yellow
        if (lowerStatus === 'not assigned') return 'background: #f3f4f6; color: #374151;'; // Gray
        return 'background: #f3f4f6; color: #374151;';
    } 
    
    [cite_start]function getStatusDot(status) { /* ... */ } // [cite: 184-187]
    [cite_start]function generateRandomConservationString() { /* ... */ } // [cite: 187-191]
    
    [cite_start]// --- DASHBOARD: SITE STATUS --- [cite: 191-198]
    function renderSiteStatusTabs() { 
        const tabs = [ { id: 'sac', name: 'SAC' }, { id: 'spa', name: 'SPA' }, { id: 'nha', name: 'NHA' } ];
        const tabsContainer = document.getElementById('site-status-tabs'); 
        if (!tabsContainer) return;
        tabsContainer.innerHTML = tabs.map(tab => ` 
            <button onclick="setSiteStatusTab('${tab.id}')" style="border-bottom: 2px solid ${currentSiteStatusTab === tab.id ? '#FB923C' : 'transparent'}; padding: 0.5rem; background: none; border: none; cursor: pointer; font-size: 1rem;"> 
                ${tab.name} 
            </button> 
        `).join('');
    } 
    
    function setSiteStatusTab(tabId) { 
        currentSiteStatusTab = tabId; 
        renderSiteStatusTabs(); 
        renderSiteStatusTabContent(); 
    } 
    
    function renderSiteStatusTabContent() { 
        const content = document.getElementById('site-status-content'); 
        if (!content) return;
        let csvData;
        if (currentSiteStatusTab === 'sac') { csvData = parseCsv(sacConditionsCsv); } 
        else if (currentSiteStatusTab === 'spa') { csvData = parseCsv(spaConditionsCsv); } 
        else { csvData = parseCsv(nhaConditionsCsv); } 
        
        let stats = { favourable: 0, unfavourable: 0, speciesFavourable: 0, total: csvData.length };
        csvData.forEach(row => { 
            if (row.Habitats_Health?.toLowerCase().includes('favourable')) stats.favourable++; 
            if (row.Habitats_Health?.toLowerCase().includes('inadequate') || row.Habitats_Health?.toLowerCase().includes('bad')) stats.unfavourable++; 
            if (row.Species_Health?.toLowerCase().includes('favourable')) stats.speciesFavourable++; 
        }); 
        document.getElementById('total-assessments-stat').textContent = stats.total;
        document.getElementById('habitats-favourable-stat').textContent = stats.favourable; 
        document.getElementById('habitats-unfavourable-stat').textContent = stats.unfavourable; 
        document.getElementById('species-favourable-stat').textContent = stats.speciesFavourable; 
        
        content.innerHTML = ` 
            <table class="projects-table" style="margin-top: 1rem;"> 
                <thead> 
                    <tr> <th>Site Code</th> <th>Site Name</th> <th>Habitats Health</th> <th>Species Health</th> <th>Last Updated</th> </tr> 
                </thead> 
                <tbody> 
                    ${csvData.map(row => { 
                        return ` 
                        <tr> 
                            <td>${row.Site_code || row.Site_Code}</td> 
                            <td>${row.Site_Name}</td> 
                            <td>${row.Habitats_Health || 'N/A'}</td> 
                            <td>${row.Species_Health || 'N/A'}</td> 
                            <td>${row.Last_Upate || row.Last_Updated || 'N/A'}</td> 
                        </tr> 
                        `}).join('')} 
                </tbody> 
            </table> 
        `;
    } 
    
    [cite_start]// --- TASKS PAGE --- [cite: 198-206]
    function renderTasksView() { 
        currentTasksTab = 'assessments'; 
        renderTasksTabs(); 
        renderTasksTabContent();
    } 
    
    function renderTasksTabs() { 
        const tabs = [ { id: 'assessments', name: 'Conservation Assessments' }, { id: 'actions', name: 'Conservation Actions' } ];
        const tabsContainer = document.getElementById('tasks-tabs'); 
        if (!tabsContainer) return;
        tabsContainer.innerHTML = tabs.map(tab => ` 
            <button onclick="setTasksTab('${tab.id}')" style="border-bottom: 2px solid ${currentTasksTab === tab.id ? '#FB923C' : 'transparent'}; padding: 0.5rem; background: none; border: none; cursor: pointer; font-size: 1rem;"> 
                ${tab.name} 
            </button> 
        `).join('');
    } 
    
    function setTasksTab(tabId) { 
        currentTasksTab = tabId; 
        renderTasksTabs(); 
        renderTasksTabContent(); 
    } 
    
    function renderTasksTabContent() { 
        const content = document.getElementById('tasks-content');
        if (!content) return;
        
        if (currentTasksTab === 'assessments') { 
            let assessmentsData = parseCsv(assessmentsCsvData); 
            const rossbehyAssessment = { SITECODE: '13', SITE_NAME: 'Rossbehy', Status: 'Completed', COUNTY: 'Kerry', HA: '91.71', Link: '#' };
            if (!assessmentsData.some(item => item.SITECODE === '13')) { 
                assessmentsData.push(rossbehyAssessment); 
            } 
            content.innerHTML = ` 
                <div class="projects-table" style="margin-top: 1rem;"> 
                    <table> 
                        <thead> 
                            <tr> <th>Site Code</th> <th>Site Name</th> <th>Status</th> <th>County</th> <th>Area (ha)</th> </tr> 
                        </thead> 
                        <tbody> 
                            ${assessmentsData.map(row => ` 
                            <tr style="${row.SITECODE == '13' ? 'cursor: pointer; background: #fefef5;' : ''}" ${row.SITECODE == '13' ? `onclick="showView('assessment-detail-view', { siteCode: 13 })"` : ''}> 
                                <td>${row.SITECODE}</td> 
                                <td>${row.SITE_NAME}</td> 
                                <td><span class="status-badge" style="${getStatusColorClass(row.Status)}">${row.Status}</span></td> 
                                <td>${row.COUNTY}</td> 
                                <td>${row.HA}</td> 
                            </tr>`).join('')} 
                        </tbody> 
                    </table> 
                </div> 
            `;
        } else if (currentTasksTab === 'actions') { 
            let actionsData = parseCsv(actionsCsvData);
            content.innerHTML = ` 
                <div class="projects-table" style="margin-top: 1rem;"> 
                    <table> 
                        <thead> 
                            <tr> <th>Site Code</th> <th>Site Name</th> <th>Status</th> <th>Action Type</th> <th>County</th> </tr> 
                        </thead> 
                        <tbody> 
                            ${actionsData.map(row => ` 
                            <tr> 
                                <td>${row.SITECODE}</td> 
                                <td>${row.SITE_NAME}</td> 
                                <td><span class="status-badge" style="${getStatusColorClass(row.Status)}">${row.Status}</span></td> 
                                <td>${row.Action_Type}</td> 
                                <td>${row.COUNTY}</td> 
                            </tr>`).join('')} 
                        </tbody> 
                    </table> 
                </div> 
            `;
        } 
    } 
    
    [cite_start]// --- VISUALISATION VIEW --- [cite: 206-218]
    const visTabs = [ 
        { id: 'basic', name: 'Basic Information', icon: 'file-text' }, 
        { id: 'impacts', name: 'Impacts', icon: 'alert-triangle' }, 
        { id: 'metrics', name: 'Metrics', icon: 'bar-chart-3' }, 
        { id: 'habitats', name: 'Habitats', icon: 'leaf' }, 
        { id: 'finish', name: 'Finish', icon: 'check-circle' } 
    ];
    
    function renderVisualisationView() { 
        currentVisualisationTab = 'basic'; 
        renderVisualisationNav(); 
        renderVisualisationContent(); 
    } 
    
    function renderVisualisationNav() { 
        const nav = document.getElementById('visualisation-nav');
        if (!nav) return;
        nav.innerHTML = visTabs.map(tab => ` 
            <button onclick="setVisualisationTab('${tab.id}')" style="padding: 0.5rem; border-radius: 4px; background: ${currentVisualisationTab === tab.id ? '#dbeafe' : 'transparent'};"> 
                <i data-lucide="${tab.icon}"></i> <span>${tab.name}</span> 
            </button> 
        `).join('');
        lucide.createIcons(); 
    } 
    
    function setVisualisationTab(tabId) { 
        currentVisualisationTab = tabId; 
        renderVisualisationNav(); 
        renderVisualisationContent(); 
    } 
    
    function renderVisualisationContent() { 
        const content = document.getElementById('visualisation-content');
        if (!content) return;
        let html = ''; 
        switch(currentVisualisationTab) { 
            case 'basic': 
                html = `<h3>Basic Information</h3><p>Configuration options for this section...</p>`;
                break; 
            case 'impacts': 
                html = `<h3>Impacts</h3><p>Data automatically populated...</p>`;
                break; 
            case 'finish': 
                html = `<h3>Finish Project Setup</h3><p>Your project is almost ready...</p>`;
                break; 
            default: 
                html = `<h3>${visTabs.find(t=>t.id===currentVisualisationTab).name}</h3><p>Configuration options...</p>`; 
        } 
        content.innerHTML = html;
    } 
    
    [cite_start]// --- AI REPORTING --- [cite: 218-227]
    function addAiChatMessage(content, isUser = false) { 
        const history = document.getElementById('ai-chat-history');
        if (!history) return;
        const messageDiv = document.createElement('div');
        messageDiv.style.padding = "0.5rem";
        messageDiv.style.borderRadius = "4px";
        messageDiv.style.marginTop = "0.5rem";
        messageDiv.style.background = isUser ? '#eee' : '#e0f7fa';
        messageDiv.innerHTML = `<p>${content}</p>`; 
        history.appendChild(messageDiv);
        history.scrollTop = history.scrollHeight; 
    } 
    
    function generateAiReport() { 
        const reportContent = document.getElementById('ai-report-content'); 
        const audience = document.getElementById('audience-tone').value;
        if (!reportContent) return;
        reportContent.innerHTML = `<div style="text-align: center; padding: 2rem;"><div class="loading-spinner" style="margin: auto;"></div><p>Generating report for: <b>${audience}</b>...</p></div>`;
        addAiChatMessage(`Okay, I'm generating a draft report for a <b>${audience}</b> audience.`);
        setTimeout(() => { 
            reportContent.innerHTML = ` 
                <h2>1.0 Introduction</h2> <p>This report presents the findings of an Ecological Impact Assessment...</p> 
                <h2>2.0 Field Survey Summary</h2> <p>Field surveys were conducted on...</p> 
                <h2>3.0 Impact Assessment (Ornithology)</h2> <p>Based on the Nature Scot Collision Risk Model...</p>
            `; 
            addAiChatMessage('The draft report is ready for your review.'); 
        }, 2500);
    } 
    
    function addVisualisation() { 
        addAiChatMessage("Sure. What kind of visualisation?");
    } 
    
    function enrichData() { 
        addAiChatMessage("Okay. Enriching report with third-party datasets...");
    } 
    
    [cite_start]// --- CORE ACTIONS --- [cite: 227-249]
    function startSurveyFromTemplate(templateId) { 
        const template = surveyTemplates.find(t => t.id === templateId); 
        document.getElementById('new-survey-template-id-input').value = templateId;
        document.getElementById('new-project-name').value = `${template.name} - ${new Date().toLocaleDateString('en-IE')}`; 
        document.getElementById('new-client-name').value = "Default Client"; 
        showNewSurveyProjectModal(); 
    } 
    
    function createNewSurveyFromModal() { 
        const templateId = document.getElementById('new-survey-template-id-input').value;
        const projectName = document.getElementById('new-project-name').value; 
        const clientName = document.getElementById('new-client-name').value; 
        if (!projectName || !clientName) { 
            showToast("Please fill out all fields.", "error"); 
            return;
        } 
        const newProjectId = (db.projects[db.projects.length - 1]?.id || 0) + 1;
        const newProject = { 
            id: newProjectId, 
            name: projectName, 
            client: clientName, 
            code: `${clientName.substring(0,3).toUpperCase()}-${String(Math.floor(100 + Math.random() * 900))}-25` 
        }; 
        db.projects.push(newProject);
        const newSurveyId = (db.surveys[db.surveys.length - 1]?.id || 0) + 1;
        db.surveys.push({ id: newSurveyId, projectId: newProjectId, siteName: "Default Site", template: templateId, status: "Ready", data: {} }); 
        saveData(); 
        hideNewSurveyProjectModal();
        if (templateId === 'EcIA') { 
            showView('eiar-editor-view', { projectId: newProjectId });
        } else if (templateId === 'ECoW') { 
            showView('ecow-editor-view', { projectId: newProjectId }); 
        } else { 
            showView('project-detail-view', newProjectId); // Show the new project
        } 
    } 
    
    function saveEiarSurvey() { 
        showToast("Survey content saved!"); 
        showView('project-detail-view', currentProjectId); // Go back to project
    } 
    
    function saveEcowReport() { 
        showToast("ECoW report saved!"); 
        showView('project-detail-view', currentProjectId); // Go back to project
    } 
    
    function assignSurvey(surveyId) { 
        const surveyLink = `${window.location.origin}${window.location.pathname}?survey=${surveyId}`; 
        document.getElementById('survey-link-input').value = surveyLink; 
        showAssignSurveyModal(); 
    } 
    
    function copySurveyLink() { 
        const input = document.getElementById('survey-link-input');
        input.select(); 
        document.execCommand('copy'); 
        showToast('Link copied to clipboard!'); 
    } 
    
    // REMOVED: generateThirdPartyLink()
    // REMOVED: copyThirdPartyLink()
    
    function displayPhotoPreview(event) { 
        const container = document.getElementById('photo-preview-container'); 
        const file = event.target.files[0]; 
        if (file) { 
            const reader = new FileReader();
            reader.onload = function(e) { 
                container.innerHTML = `<img src="${e.target.result}" style="max-height: 160px; max-width: 100%; border-radius: 4px;">`; 
            } 
            reader.readAsDataURL(file);
        } 
    } 
    
    function submitSurvey() { 
        const surveyId = document.getElementById('survey-id-input').value; 
        const survey = db.surveys.find(s => s.id == surveyId);
        if (survey) { 
            survey.status = "Completed"; 
            survey.data = { 
                habitat: document.getElementById('habitat-type').value, 
                notes: document.getElementById('habitat-notes').value, 
                species: document.getElementById('species-observed').value, 
                speciesNotes: document.getElementById('species-notes').value, 
                photo: document.querySelector('#photo-preview-container img')?.src || '' 
            }; 
            saveData(); 
            document.getElementById('mobile-survey-form').innerHTML = ` 
                <div style="text-align: center; padding: 2rem;"> 
                    <i data-lucide="check-circle" style="width: 64px; height: 64px; color: #10B981; margin: auto;"></i> 
                    <h2>Survey Submitted</h2> 
                    <p>Thank you. Your data has been recorded.</p> 
                    <button onclick="closeSurveyWindow()">Close Window</button> 
                </div> 
            `; 
            lucide.createIcons();
        } else { 
            showToast('Error: Could not find survey.', 'error'); 
        } 
    } 
    
    function closeSurveyWindow(){ 
        window.location.href = window.location.pathname;
    } 
    
    [cite_start]// --- REPORT GENERATION --- [cite: 249-255]
    function generateReport(surveyId) { 
        if (typeof docx === 'undefined' || typeof saveAs === 'undefined') {
            showToast('Report libraries not loaded.', 'error');
            return;
        }

        const survey = db.surveys.find(s => s.id === surveyId);
        const project = db.projects.find(p => p.id === survey.projectId); 
        const template = surveyTemplates.find(t => t.id === survey.template);
        const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;
        
        const doc = new Document({ 
            sections: [{ 
                properties: {}, 
                children: [ 
                    new Paragraph({ text: template.name, heading: HeadingLevel.TITLE }), 
                    new Paragraph({ text: `Project: ${project.name}`, style: "IntenseQuote" }), 
                    new Paragraph({ text: `Client: ${project.client}`, style: "IntenseQuote" }), 
                    new Paragraph({ text: `Survey Site: ${survey.siteName}`, style: "IntenseQuote" }), 
                    new Paragraph({ text: `Date: ${new Date().toLocaleDateString('en-IE')}` }), 
                    
                    new Paragraph({ text: "1.0 Desk Study", heading: HeadingLevel.HEADING_1, spacing: { before: 200 } }), 
                    new Paragraph("A desk-based study was undertaken..."), 
                    
                    new Paragraph({ text: "2.0 Field Survey Results", heading: HeadingLevel.HEADING_1, spacing: { before: 200 } }), 
                    new Paragraph({ text: "2.1 Habitats", heading: HeadingLevel.HEADING_2, spacing: { before: 200 } }), 
                    new Paragraph(new TextRun({ text: "Habitat Type:", bold: true }).addChild(new TextRun(` ${survey.data.habitat || 'N/A'}`))), 
                    new Paragraph(new TextRun({ text: "Condition Notes:", bold: true }).addChild(new TextRun(` ${survey.data.notes || 'N/A'}`))), 
                    
                    new Paragraph({ text: "2.2 Species", heading: HeadingLevel.HEADING_2, spacing: { before: 200 } }), 
                    new Paragraph(new TextRun({ text: "Species Observed:", bold: true }).addChild(new TextRun(` ${survey.data.species || 'None.'}`))), 
                ], 
            }], 
        });
        
        Packer.toBlob(doc).then(blob => { 
            saveAs(blob, `${project.code}_${template.id}_Report.docx`); 
            showToast("Report downloaded!"); 
        }); 
    } 
    
    // --- INITIALIZATION (FIX: Removed faulty function calls) ---
    document.addEventListener('DOMContentLoaded', () => { 
        loadData(); 
        lucide.createIcons(); 
        handleRouting(); 
        // (Removed addHabitatEntry(), etc. They are now called by buttons)
    });
    </script>
</body>
</html>
